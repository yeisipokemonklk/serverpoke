{
  "version": 3,
  "sources": ["../../../server/sockets.ts"],
  "sourcesContent": ["/**\r\n * Connections\r\n * Pokemon Showdown - http://pokemonshowdown.com/\r\n *\r\n * Abstraction layer for multi-process SockJS connections.\r\n *\r\n * This file handles all the communications between the users'\r\n * browsers, the networking processes, and users.ts in the\r\n * main process.\r\n *\r\n * @license MIT\r\n */\r\n\r\nimport * as fs from 'fs';\r\nimport * as http from 'http';\r\nimport * as https from 'https';\r\nimport * as path from 'path';\r\nimport {crashlogger, ProcessManager, Streams, Repl} from '../lib';\r\nimport {IPTools} from './ip-tools';\r\nimport {ChannelID, extractChannelMessages} from '../sim/battle';\r\n\r\ntype StreamWorker = ProcessManager.StreamWorker;\r\n\r\nexport const Sockets = new class {\r\n\tasync onSpawn(worker: StreamWorker) {\r\n\t\tconst id = worker.workerid;\r\n\t\tfor await (const data of worker.stream) {\r\n\t\t\tswitch (data.charAt(0)) {\r\n\t\t\tcase '*': {\r\n\t\t\t\t// *socketid, ip, protocol\r\n\t\t\t\t// connect\r\n\t\t\t\tworker.load++;\r\n\t\t\t\tconst [socketid, ip, protocol] = data.substr(1).split('\\n');\r\n\t\t\t\tUsers.socketConnect(worker, id, socketid, ip, protocol);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tcase '!': {\r\n\t\t\t\t// !socketid\r\n\t\t\t\t// disconnect\r\n\t\t\t\tworker.load--;\r\n\t\t\t\tconst socketid = data.substr(1);\r\n\t\t\t\tUsers.socketDisconnect(worker, id, socketid);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tcase '<': {\r\n\t\t\t\t// <socketid, message\r\n\t\t\t\t// message\r\n\t\t\t\tconst idx = data.indexOf('\\n');\r\n\t\t\t\tconst socketid = data.substr(1, idx - 1);\r\n\t\t\t\tconst message = data.substr(idx + 1);\r\n\t\t\t\tUsers.socketReceive(worker, id, socketid, message);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tdefault:\r\n\t\t\t// unhandled\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tonUnspawn(worker: StreamWorker) {\r\n\t\tUsers.socketDisconnectAll(worker, worker.workerid);\r\n\t}\r\n\r\n\tlisten(port?: number, bindAddress?: string, workerCount?: number) {\r\n\t\tif (port !== undefined && !isNaN(port)) {\r\n\t\t\tConfig.port = port;\r\n\t\t\tConfig.ssl = null;\r\n\t\t} else {\r\n\t\t\tport = Config.port;\r\n\r\n\t\t\t// Autoconfigure when running in cloud environments.\r\n\t\t\ttry {\r\n\t\t\t\tconst cloudenv = (require as any)('cloud-env');\r\n\t\t\t\tbindAddress = cloudenv.get('IP', bindAddress);\r\n\t\t\t\tport = cloudenv.get('PORT', port);\r\n\t\t\t} catch {}\r\n\t\t}\r\n\t\tif (bindAddress !== undefined) {\r\n\t\t\tConfig.bindaddress = bindAddress;\r\n\t\t}\r\n\t\tif (port !== undefined) {\r\n\t\t\tConfig.port = port;\r\n\t\t}\r\n\t\tif (workerCount === undefined) {\r\n\t\t\tworkerCount = (Config.workers !== undefined ? Config.workers : 1);\r\n\t\t}\r\n\r\n\t\tPM.env = {PSPORT: Config.port, PSBINDADDR: Config.bindaddress || '0.0.0.0', PSNOSSL: Config.ssl ? 0 : 1};\r\n\t\tPM.subscribeSpawn(worker => void this.onSpawn(worker));\r\n\t\tPM.subscribeUnspawn(this.onUnspawn);\r\n\r\n\t\tPM.spawn(workerCount);\r\n\t}\r\n\r\n\tsocketSend(worker: StreamWorker, socketid: string, message: string) {\r\n\t\tvoid worker.stream.write(`>${socketid}\\n${message}`);\r\n\t}\r\n\r\n\tsocketDisconnect(worker: StreamWorker, socketid: string) {\r\n\t\tvoid worker.stream.write(`!${socketid}`);\r\n\t}\r\n\r\n\troomBroadcast(roomid: RoomID, message: string) {\r\n\t\tfor (const worker of PM.workers) {\r\n\t\t\tvoid worker.stream.write(`#${roomid}\\n${message}`);\r\n\t\t}\r\n\t}\r\n\r\n\troomAdd(worker: StreamWorker, roomid: RoomID, socketid: string) {\r\n\t\tvoid worker.stream.write(`+${roomid}\\n${socketid}`);\r\n\t}\r\n\r\n\troomRemove(worker: StreamWorker, roomid: RoomID, socketid: string) {\r\n\t\tvoid worker.stream.write(`-${roomid}\\n${socketid}`);\r\n\t}\r\n\r\n\tchannelBroadcast(roomid: RoomID, message: string) {\r\n\t\tfor (const worker of PM.workers) {\r\n\t\t\tvoid worker.stream.write(`:${roomid}\\n${message}`);\r\n\t\t}\r\n\t}\r\n\r\n\tchannelMove(worker: StreamWorker, roomid: RoomID, channelid: ChannelID, socketid: string) {\r\n\t\tvoid worker.stream.write(`.${roomid}\\n${channelid}\\n${socketid}`);\r\n\t}\r\n\r\n\teval(worker: StreamWorker, query: string) {\r\n\t\tvoid worker.stream.write(`$${query}`);\r\n\t}\r\n};\r\n\r\nexport class ServerStream extends Streams.ObjectReadWriteStream<string> {\r\n\t/** socketid:Connection */\r\n\tsockets = new Map<string, import('sockjs').Connection>();\r\n\t/** roomid:socketid:Connection */\r\n\trooms = new Map<RoomID, Map<string, import('sockjs').Connection>>();\r\n\t/** roomid:socketid:channelid */\r\n\troomChannels = new Map<RoomID, Map<string, ChannelID>>();\r\n\r\n\tserver: http.Server;\r\n\tserverSsl: https.Server | null;\r\n\tsocketCounter = 0;\r\n\r\n\tisTrustedProxyIp: (ip: string) => boolean;\r\n\r\n\treceivers: {[k: string]: (this: ServerStream, data: string) => void} = {\r\n\t\t'$'(data) {\r\n\t\t\t// $code\r\n\t\t\t// eslint-disable-next-line no-eval\r\n\t\t\teval(data.substr(1));\r\n\t\t},\r\n\t\t'!'(data) {\r\n\t\t\t// !socketid\r\n\t\t\t// destroy\r\n\t\t\tconst socketid = data.substr(1);\r\n\t\t\tconst socket = this.sockets.get(socketid);\r\n\t\t\tif (!socket) return;\r\n\t\t\tsocket.destroy();\r\n\t\t\tthis.sockets.delete(socketid);\r\n\t\t\tfor (const [curRoomid, curRoom] of this.rooms) {\r\n\t\t\t\tcurRoom.delete(socketid);\r\n\t\t\t\tconst roomChannel = this.roomChannels.get(curRoomid);\r\n\t\t\t\tif (roomChannel) roomChannel.delete(socketid);\r\n\t\t\t\tif (!curRoom.size) {\r\n\t\t\t\t\tthis.rooms.delete(curRoomid);\r\n\t\t\t\t\tif (roomChannel) this.roomChannels.delete(curRoomid);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\t'>'(data) {\r\n\t\t\t// >socketid, message\r\n\t\t\t// message to single connection\r\n\t\t\tconst nlLoc = data.indexOf('\\n');\r\n\t\t\tconst socketid = data.substr(1, nlLoc - 1);\r\n\t\t\tconst socket = this.sockets.get(socketid);\r\n\t\t\tif (!socket) return;\r\n\t\t\tconst message = data.substr(nlLoc + 1);\r\n\t\t\tsocket.write(message);\r\n\t\t},\r\n\t\t'#'(data) {\r\n\t\t\t// #roomid, message\r\n\t\t\t// message to all connections in room\r\n\t\t\t// #, message\r\n\t\t\t// message to all connections\r\n\t\t\tconst nlLoc = data.indexOf('\\n');\r\n\t\t\tconst roomid = data.substr(1, nlLoc - 1) as RoomID;\r\n\t\t\tconst room = roomid ? this.rooms.get(roomid) : this.sockets;\r\n\t\t\tif (!room) return;\r\n\t\t\tconst message = data.substr(nlLoc + 1);\r\n\t\t\tfor (const curSocket of room.values()) curSocket.write(message);\r\n\t\t},\r\n\t\t'+'(data) {\r\n\t\t\t// +roomid, socketid\r\n\t\t\t// join room with connection\r\n\t\t\tconst nlLoc = data.indexOf('\\n');\r\n\t\t\tconst socketid = data.substr(nlLoc + 1);\r\n\t\t\tconst socket = this.sockets.get(socketid);\r\n\t\t\tif (!socket) return;\r\n\t\t\tconst roomid = data.substr(1, nlLoc - 1) as RoomID;\r\n\t\t\tlet room = this.rooms.get(roomid);\r\n\t\t\tif (!room) {\r\n\t\t\t\troom = new Map();\r\n\t\t\t\tthis.rooms.set(roomid, room);\r\n\t\t\t}\r\n\t\t\troom.set(socketid, socket);\r\n\t\t},\r\n\t\t'-'(data) {\r\n\t\t\t// -roomid, socketid\r\n\t\t\t// leave room with connection\r\n\t\t\tconst nlLoc = data.indexOf('\\n');\r\n\t\t\tconst roomid = data.slice(1, nlLoc) as RoomID;\r\n\t\t\tconst room = this.rooms.get(roomid);\r\n\t\t\tif (!room) return;\r\n\t\t\tconst socketid = data.slice(nlLoc + 1);\r\n\t\t\troom.delete(socketid);\r\n\t\t\tconst roomChannel = this.roomChannels.get(roomid);\r\n\t\t\tif (roomChannel) roomChannel.delete(socketid);\r\n\t\t\tif (!room.size) {\r\n\t\t\t\tthis.rooms.delete(roomid);\r\n\t\t\t\tif (roomChannel) this.roomChannels.delete(roomid);\r\n\t\t\t}\r\n\t\t},\r\n\t\t'.'(data) {\r\n\t\t\t// .roomid, channelid, socketid\r\n\t\t\t// move connection to different channel in room\r\n\t\t\tconst nlLoc = data.indexOf('\\n');\r\n\t\t\tconst roomid = data.slice(1, nlLoc) as RoomID;\r\n\t\t\tconst nlLoc2 = data.indexOf('\\n', nlLoc + 1);\r\n\t\t\tconst channelid = Number(data.slice(nlLoc + 1, nlLoc2)) as ChannelID;\r\n\t\t\tconst socketid = data.slice(nlLoc2 + 1);\r\n\r\n\t\t\tlet roomChannel = this.roomChannels.get(roomid);\r\n\t\t\tif (!roomChannel) {\r\n\t\t\t\troomChannel = new Map();\r\n\t\t\t\tthis.roomChannels.set(roomid, roomChannel);\r\n\t\t\t}\r\n\t\t\tif (channelid === 0) {\r\n\t\t\t\troomChannel.delete(socketid);\r\n\t\t\t} else {\r\n\t\t\t\troomChannel.set(socketid, channelid);\r\n\t\t\t}\r\n\t\t},\r\n\t\t':'(data) {\r\n\t\t\t// :roomid, message\r\n\t\t\t// message to a room, splitting `|split` by channel\r\n\t\t\tconst nlLoc = data.indexOf('\\n');\r\n\t\t\tconst roomid = data.slice(1, nlLoc) as RoomID;\r\n\t\t\tconst room = this.rooms.get(roomid);\r\n\t\t\tif (!room) return;\r\n\r\n\t\t\tconst messages: [string | null, string | null, string | null, string | null, string | null] = [\r\n\t\t\t\tnull, null, null, null, null,\r\n\t\t\t];\r\n\t\t\tconst message = data.substr(nlLoc + 1);\r\n\t\t\tconst channelMessages = extractChannelMessages(message, [0, 1, 2, 3, 4]);\r\n\t\t\tconst roomChannel = this.roomChannels.get(roomid);\r\n\t\t\tfor (const [curSocketid, curSocket] of room) {\r\n\t\t\t\tconst channelid = roomChannel?.get(curSocketid) || 0;\r\n\t\t\t\tif (!messages[channelid]) messages[channelid] = channelMessages[channelid].join('\\n');\r\n\t\t\t\tcurSocket.write(messages[channelid]!);\r\n\t\t\t}\r\n\t\t},\r\n\t};\r\n\r\n\tconstructor(config: {\r\n\t\tport: number,\r\n\t\tbindaddress?: string,\r\n\t\tssl?: typeof Config.ssl,\r\n\t\twsdeflate?: typeof Config.wsdeflate,\r\n\t\tproxyip?: typeof Config.proxyip,\r\n\t\tcustomhttpresponse?: typeof Config.customhttpresponse,\r\n\t\tdisablenodestatic?: boolean,\r\n\t}) {\r\n\t\tsuper();\r\n\t\tif (!config.bindaddress) config.bindaddress = '0.0.0.0';\r\n\r\n\t\tthis.isTrustedProxyIp = config.proxyip ? IPTools.checker(config.proxyip) : () => false;\r\n\r\n\t\t// Static HTTP server\r\n\r\n\t\t// This handles the custom CSS and custom avatar features, and also\r\n\t\t// redirects yourserver:8001 to yourserver-8001.psim.us\r\n\r\n\t\t// It's optional if you don't need these features.\r\n\r\n\t\tthis.server = http.createServer();\r\n\t\tthis.serverSsl = null;\r\n\t\tif (config.ssl) {\r\n\t\t\tlet key;\r\n\t\t\ttry {\r\n\t\t\t\tkey = path.resolve(__dirname, config.ssl.options.key);\r\n\t\t\t\tif (!fs.statSync(key).isFile()) throw new Error();\r\n\t\t\t\ttry {\r\n\t\t\t\t\tkey = fs.readFileSync(key);\r\n\t\t\t\t} catch (e: any) {\r\n\t\t\t\t\tcrashlogger(\r\n\t\t\t\t\t\tnew Error(`Failed to read the configured SSL private key PEM file:\\n${e.stack}`),\r\n\t\t\t\t\t\t`Socket process ${process.pid}`\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t} catch {\r\n\t\t\t\tconsole.warn('SSL private key config values will not support HTTPS server option values in the future. Please set it to use the absolute path of its PEM file.');\r\n\t\t\t\tkey = config.ssl.options.key;\r\n\t\t\t}\r\n\r\n\t\t\tlet cert;\r\n\t\t\ttry {\r\n\t\t\t\tcert = path.resolve(__dirname, config.ssl.options.cert);\r\n\t\t\t\tif (!fs.statSync(cert).isFile()) throw new Error();\r\n\t\t\t\ttry {\r\n\t\t\t\t\tcert = fs.readFileSync(cert);\r\n\t\t\t\t} catch (e: any) {\r\n\t\t\t\t\tcrashlogger(\r\n\t\t\t\t\t\tnew Error(`Failed to read the configured SSL certificate PEM file:\\n${e.stack}`),\r\n\t\t\t\t\t\t`Socket process ${process.pid}`\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t} catch (e: any) {\r\n\t\t\t\tconsole.warn('SSL certificate config values will not support HTTPS server option values in the future. Please set it to use the absolute path of its PEM file.');\r\n\t\t\t\tcert = config.ssl.options.cert;\r\n\t\t\t}\r\n\r\n\t\t\tif (key && cert) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\t// In case there are additional SSL config settings besides the key and cert...\r\n\t\t\t\t\tthis.serverSsl = https.createServer({...config.ssl.options, key, cert});\r\n\t\t\t\t} catch (e: any) {\r\n\t\t\t\t\tcrashlogger(new Error(`The SSL settings are misconfigured:\\n${e.stack}`), `Socket process ${process.pid}`);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Static server\r\n\t\ttry {\r\n\t\t\tif (config.disablenodestatic) throw new Error(\"disablenodestatic\");\r\n\t\t\tconst StaticServer: typeof import('node-static').Server = require('node-static').Server;\r\n\t\t\tconst roomidRegex = /^\\/(?:[A-Za-z0-9][A-Za-z0-9-]*)\\/?$/;\r\n\t\t\tconst cssServer = new StaticServer('./config');\r\n\t\t\tconst avatarServer = new StaticServer('./config/avatars');\r\n\t\t\tconst staticServer = new StaticServer('./server/static');\r\n\t\t\tconst staticRequestHandler = (req: http.IncomingMessage, res: http.ServerResponse) => {\r\n\t\t\t\t// console.log(`static rq: ${req.socket.remoteAddress}:${req.socket.remotePort} -> ${req.socket.localAddress}:${req.socket.localPort} - ${req.method} ${req.url} ${req.httpVersion} - ${req.rawHeaders.join('|')}`);\r\n\t\t\t\treq.resume();\r\n\t\t\t\treq.addListener('end', () => {\r\n\t\t\t\t\tif (config.customhttpresponse &&\r\n\t\t\t\t\t\t\tconfig.customhttpresponse(req, res)) {\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tlet server = staticServer;\r\n\t\t\t\t\tif (req.url) {\r\n\t\t\t\t\t\tif (req.url === '/custom.css') {\r\n\t\t\t\t\t\t\tserver = cssServer;\r\n\t\t\t\t\t\t} else if (req.url.startsWith('/avatars/')) {\r\n\t\t\t\t\t\t\treq.url = req.url.substr(8);\r\n\t\t\t\t\t\t\tserver = avatarServer;\r\n\t\t\t\t\t\t} else if (roomidRegex.test(req.url)) {\r\n\t\t\t\t\t\t\treq.url = '/';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tserver.serve(req, res, e => {\r\n\t\t\t\t\t\tif (e && (e as any).status === 404) {\r\n\t\t\t\t\t\t\tstaticServer.serveFile('404.html', 404, {}, req, res);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t};\r\n\r\n\t\t\tthis.server.on('request', staticRequestHandler);\r\n\t\t\tif (this.serverSsl) this.serverSsl.on('request', staticRequestHandler);\r\n\t\t} catch (e: any) {\r\n\t\t\tif (e.message === 'disablenodestatic') {\r\n\t\t\t\tconsole.log('node-static is disabled');\r\n\t\t\t} else {\r\n\t\t\t\tconsole.log('Could not start node-static - try `npm install` if you want to use it');\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// SockJS server\r\n\r\n\t\t// This is the main server that handles users connecting to our server\r\n\t\t// and doing things on our server.\r\n\r\n\t\tconst sockjs: typeof import('sockjs') = (require as any)('sockjs');\r\n\t\tconst options: import('sockjs').ServerOptions & {faye_server_options?: {[key: string]: any}} = {\r\n\t\t\tsockjs_url: `//play.pokemonshowdown.com/js/lib/sockjs-1.4.0-nwjsfix.min.js`,\r\n\t\t\tprefix: '/showdown',\r\n\t\t\tlog(severity: string, message: string) {\r\n\t\t\t\tif (severity === 'error') console.log(`ERROR: ${message}`);\r\n\t\t\t},\r\n\t\t};\r\n\r\n\t\tif (config.wsdeflate !== null) {\r\n\t\t\ttry {\r\n\t\t\t\tconst deflate = (require as any)('permessage-deflate').configure(config.wsdeflate);\r\n\t\t\t\toptions.faye_server_options = {extensions: [deflate]};\r\n\t\t\t} catch {\r\n\t\t\t\tcrashlogger(\r\n\t\t\t\t\tnew Error(\"Dependency permessage-deflate is not installed or is otherwise unaccessable. No message compression will take place until server restart.\"),\r\n\t\t\t\t\t\"Sockets\"\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst server = sockjs.createServer(options);\r\n\r\n\t\tprocess.once('disconnect', () => this.cleanup());\r\n\t\tprocess.once('exit', () => this.cleanup());\r\n\r\n\t\t// this is global so it can be hotpatched if necessary\r\n\t\tserver.on('connection', connection => this.onConnection(connection));\r\n\t\tserver.installHandlers(this.server, {});\r\n\t\tthis.server.listen(config.port, config.bindaddress);\r\n\t\tconsole.log(`Worker ${PM.workerid} now listening on ${config.bindaddress}:${config.port}`);\r\n\r\n\t\tif (this.serverSsl) {\r\n\t\t\tserver.installHandlers(this.serverSsl, {});\r\n\t\t\t// @ts-ignore - if appssl exists, then `config.ssl` must also exist\r\n\t\t\tthis.serverSsl.listen(config.ssl.port, config.bindaddress);\r\n\t\t\t// @ts-ignore - if appssl exists, then `config.ssl` must also exist\r\n\t\t\tconsole.log(`Worker ${PM.workerid} now listening for SSL on port ${config.ssl.port}`);\r\n\t\t}\r\n\r\n\t\tconsole.log(`Test your server at http://${config.bindaddress === '0.0.0.0' ? 'localhost' : config.bindaddress}:${config.port}`);\r\n\t}\r\n\r\n\t/**\r\n\t * Clean up any remaining connections on disconnect. If this isn't done,\r\n\t * the process will not exit until any remaining connections have been destroyed.\r\n\t * Afterwards, the worker process will die on its own\r\n\t */\r\n\tcleanup() {\r\n\t\tfor (const socket of this.sockets.values()) {\r\n\t\t\ttry {\r\n\t\t\t\tsocket.destroy();\r\n\t\t\t} catch {}\r\n\t\t}\r\n\t\tthis.sockets.clear();\r\n\t\tthis.rooms.clear();\r\n\t\tthis.roomChannels.clear();\r\n\r\n\t\tthis.server.close();\r\n\t\tif (this.serverSsl) this.serverSsl.close();\r\n\r\n\t\t// Let the server(s) finish closing.\r\n\t\tsetImmediate(() => process.exit(0));\r\n\t}\r\n\r\n\tonConnection(socket: import('sockjs').Connection) {\r\n\t\t// For reasons that are not entirely clear, SockJS sometimes triggers\r\n\t\t// this event with a null `socket` argument.\r\n\t\tif (!socket) return;\r\n\r\n\t\tif (!socket.remoteAddress) {\r\n\t\t\t// SockJS sometimes fails to be able to cache the IP, port, and\r\n\t\t\t// address from connection request headers.\r\n\t\t\ttry {\r\n\t\t\t\tsocket.destroy();\r\n\t\t\t} catch {}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst socketid = '' + (++this.socketCounter);\r\n\t\tthis.sockets.set(socketid, socket);\r\n\r\n\t\tlet socketip = socket.remoteAddress;\r\n\t\tif (this.isTrustedProxyIp(socketip)) {\r\n\t\t\tconst ips = (socket.headers['x-forwarded-for'] || '').split(',').reverse();\r\n\t\t\tfor (const ip of ips) {\r\n\t\t\t\tconst proxy = ip.trim();\r\n\t\t\t\tif (!this.isTrustedProxyIp(proxy)) {\r\n\t\t\t\t\tsocketip = proxy;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.push(`*${socketid}\\n${socketip}\\n${socket.protocol}`);\r\n\r\n\t\tsocket.on('data', message => {\r\n\t\t\t// drop empty messages (DDoS?)\r\n\t\t\tif (!message) return;\r\n\t\t\t// drop messages over 100KB\r\n\t\t\tif (message.length > (100 * 1024)) {\r\n\t\t\t\tsocket.write(`|popup|Your message must be below 100KB`);\r\n\t\t\t\tconsole.log(`Dropping client message ${message.length / 1024} KB...`);\r\n\t\t\t\tconsole.log(message.slice(0, 160));\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t// drop legacy JSON messages\r\n\t\t\tif (typeof message !== 'string' || message.startsWith('{')) return;\r\n\t\t\t// drop blank messages (DDoS?)\r\n\t\t\tconst pipeIndex = message.indexOf('|');\r\n\t\t\tif (pipeIndex < 0 || pipeIndex === message.length - 1) return;\r\n\r\n\t\t\tthis.push(`<${socketid}\\n${message}`);\r\n\t\t});\r\n\r\n\t\tsocket.once('close', () => {\r\n\t\t\tthis.push(`!${socketid}`);\r\n\t\t\tthis.sockets.delete(socketid);\r\n\t\t\tfor (const room of this.rooms.values()) room.delete(socketid);\r\n\t\t});\r\n\t}\r\n\r\n\t_write(data: string) {\r\n\t\t// console.log('worker received: ' + data);\r\n\r\n\t\tconst receiver = this.receivers[data.charAt(0)];\r\n\t\tif (receiver) receiver.call(this, data);\r\n\t}\r\n}\r\n\r\n/*********************************************************\r\n * Process manager\r\n *********************************************************/\r\n\r\nexport const PM = new ProcessManager.RawProcessManager({\r\n\tmodule,\r\n\tsetupChild: () => new ServerStream(Config),\r\n\tisCluster: true,\r\n});\r\n\r\nif (!PM.isParentProcess) {\r\n\t// This is a child process!\r\n\tglobal.Config = (require as any)('./config-loader').Config;\r\n\r\n\tif (Config.crashguard) {\r\n\t\t// graceful crash - allow current battles to finish before restarting\r\n\t\tprocess.on('uncaughtException', err => {\r\n\t\t\tcrashlogger(err, `Socket process ${PM.workerid} (${process.pid})`);\r\n\t\t});\r\n\t\tprocess.on('unhandledRejection', err => {\r\n\t\t\tcrashlogger(err as any || {}, `Socket process ${PM.workerid} (${process.pid}) Promise`);\r\n\t\t});\r\n\t}\r\n\r\n\tif (Config.sockets) {\r\n\t\ttry {\r\n\t\t\trequire.resolve('node-oom-heapdump');\r\n\t\t} catch (e: any) {\r\n\t\t\tif (e.code !== 'MODULE_NOT_FOUND') throw e; // should never happen\r\n\t\t\tthrow new Error(\r\n\t\t\t\t'node-oom-heapdump is not installed, but it is a required dependency if Config.ofesockets is set to true! ' +\r\n\t\t\t\t'Run npm install node-oom-heapdump and restart the server.'\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\t// Create a heapdump if the process runs out of memory.\r\n\t\t(global as any).nodeOomHeapdump = (require as any)('node-oom-heapdump')({\r\n\t\t\taddTimestamp: true,\r\n\t\t});\r\n\t}\r\n\r\n\t// setup worker\r\n\tif (process.env.PSPORT) Config.port = +process.env.PSPORT;\r\n\tif (process.env.PSBINDADDR) Config.bindaddress = process.env.PSBINDADDR;\r\n\tif (process.env.PSNOSSL && parseInt(process.env.PSNOSSL)) Config.ssl = null;\r\n\r\n\t// eslint-disable-next-line no-eval\r\n\tRepl.start(`sockets-${PM.workerid}-${process.pid}`, cmd => eval(cmd));\r\n}\r\n"],
  "mappings": "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",
  "names": ["data", "server"]
}
